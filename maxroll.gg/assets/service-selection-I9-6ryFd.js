import{r as o,j as e}from"./jsx-runtime-BmCkTyBI.js";import{c as de}from"./mid-ad-container-CtoYpZdm.js";import{y as ue}from"./useSyncLeagueStores-9jK57x3p.js";import{H as W,p as q,a2 as me,as as pe,ad as ve,f as Q,ag as _,ah as U,ai as A,aa as I,ak as K,F as ge,al as xe,m as he,L as fe,e as je,a5 as ee,n as re,a9 as Se,U as ye,V as Ne}from"./useUiStateStore-BTW2eq2x.js";import{s as X}from"./index-0f3ee958-DZWNGZaJ.js";import"./index-B7uSRlxY.js";import{m as we,t as be}from"./input-CP8d1LBk.js";import{c as Ce,q as se}from"./service-table-columns-Bq_v5G7F.js";import{c as F,s as $e,a as ke,G as Be,b as Me,t as Ie,h as Le}from"./obscenity-Bs8f5lhx.js";import{i as Te}from"./useMainIgn-C4RS_MXP.js";import{I as G}from"./store-provider-BA37OI_d.js";import{s as Ee,I as Oe,E as Ve,a as Re,i as Pe,$ as De,g as Fe,P as ze}from"./hover-card-evu0jAM8.js";import{y as ae,g as Ge,u as ie}from"./tabs-dB-_aH7C.js";import{c as qe}from"./dialog-BgY3zGCx.js";import{t as J}from"./info-CilF81GL.js";const He=(S,j,y,m,u)=>{const{t:c}=W(),[h,C]=F(q(p=>[p.listingSettings,p.setListingSettings])),N=j==="poe1"?"c":"ex",P=o.useMemo(()=>{const p=f=>m.services.map(i=>{var r;const g=G(i.value,f),l=(r=h[m.value])==null?void 0:r[g];let n=(l==null?void 0:l.serviceName)||i.value;if(l!=null&&l.isCustomService){const d=$e.getAllMatches(n||"");n=ke.applyTo(n||"",d)}else n=i?i.group&&!i.hideGroupPrefix?c("services.groupedService",{group:c(`services.${i.group}`),service:c(`services.${i.label||i.value}`)}):c(`services.${i.label||i.value}`):l?c(`services.${l.serviceName.replace("Cruel","")}`):"Unknown";return{poe:j,location:f,serviceCategory:m.value,serviceName:i.value,isCustomService:!1,contactDirection:"SellerToBuyer",priceType:(l==null?void 0:l.priceType)||N,serviceNameItem:i,shownServiceName:n,disabledInputs:!0,...l||{}}});return{Seller:p("Seller"),Buyer:p("Buyer")}},[N,h,j,m.services,m.value,c]),L=p=>{C(f=>{const i={...f[m.value]};let g={Buyer:[],Seller:[]};const l=n=>{m.services.forEach(r=>{const d=G(r.value,n),t=i[d];t&&g[n].push(t)})};return l("Seller"),l("Buyer"),typeof p=="function"?g=p(g):g=p,Object.entries(g).forEach(([n,r])=>{r.forEach(d=>{const t=G(d.serviceName,n);i[t]={serviceName:d.serviceName,isCustomService:d.isCustomService,message:d.message,contactDirection:d.contactDirection,priceType:d.priceType||N,priceValue:d.priceValue,tags:d.tags}})}),{...f,[m.value]:{...i}}})},{data:$,isFetching:T}=me(pe(S,j,y));return o.useEffect(()=>{var p;if($){const f=m.value,i={};$.forEach(r=>{i[r.serviceCategory]||(i[r.serviceCategory]=[]),i[r.serviceCategory].push(r)});const g={},l=r=>{m.services.forEach(d=>{var E;const t=(E=i[f])==null?void 0:E.find(a=>a.serviceName===d.value&&a.location===r);if(!t)return;const k={serviceName:t.serviceName,isCustomService:t.isCustomService,message:t.message,contactDirection:t.contactDirection,priceType:t.priceType||N,priceValue:t.priceValue,tags:t.tags},B=G(d.value,r);g[B]=k})};l("Seller"),l("Buyer");const n={Buyer:{},Seller:{}};(p=i[f])==null||p.forEach(r=>{r.location==="Buyer"?n.Buyer[r.serviceName]=!0:n.Seller[r.serviceName]=!0}),u(n),C(r=>({...r,[f]:{...r[f],...g}}))}},[$,m,u,C,N]),{modifiedListings:P,setModifiedListings:L,myListings:$}},le=Ee({columnSizing:{},pageSize:100,columnOrder:[],columnVisiblity:{},scrollMode:"windowInfinite",rowHeight:49},{persistPrefix:"service-listing-tool",version:2}),Ue=({className:S,columns:j,selectedStatus:y,setSelectedStatus:m,currentLocation:u,setCurrentLocation:c,modifiedListings:h,setModifiedListings:C,selectedServices:N,setSelectedServices:P})=>{const{t:L}=W(),[$]=X(a=>({loaded:a.viewport.loaded,md:a.viewport.md})),T=$.loaded&&!$.md,p=o.useCallback((a,x,b)=>{C(O=>{const V=O[u],R=V.findIndex(D=>D.serviceName===a),M=[...V];if(R!==-1)return M[R]={...M[R],[x]:b},{...O,[u]:M};const v=h[u].find(D=>D.serviceName===a);return M.push({serviceName:a,contactDirection:v==null?void 0:v.contactDirection,priceType:v==null?void 0:v.priceType,message:v==null?void 0:v.message,priceValue:v==null?void 0:v.priceValue,tags:v==null?void 0:v.tags,[x]:b}),{...O,[u]:M}})},[u,h,C]),f=o.useCallback(a=>{let x=N[u];typeof a=="function"?x=a(x):x=a,P(b=>({...b,[u]:x}))},[u,N,P]),i=N[u],[g,l]=o.useState(""),{tableState:n,setTablePageIndex:r}=Oe(le),{tableRef:d,handleTableReset:t}=Ve(),k=o.useCallback(a=>{l(a),r(0)},[l,r]),B=o.useCallback((a,x,b,O)=>Re.includesString(a,x,b,O),[]),E=o.useMemo(()=>({data:h[u],columns:j,getRowId:a=>a.serviceName,enableMultiSort:!1,onGlobalFilterChange:k,onRowSelectionChange:f,globalFilterFn:B,...n.setState,state:{globalFilter:g,rowSelection:i,...n.state},initialState:{sorting:[],columnVisibility:{},columnOrder:["selected","serviceName","message","priceValue","rewards","tags","contactDirection"]},meta:{updateData(a,x,b){p(a,x,b)}}}),[j,u,g,B,h,k,f,i,n.setState,n.state,p]);return e.jsx(Pe,{storeContext:le,children:e.jsxs("div",{className:S,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[!T&&e.jsx(De,{value:g??"",onChange:a=>k(String(a)),onBlur:a=>k(String(a)),className:"pl-8 max-w-48",placeholder:L("label.searchPh"),startIcon:e.jsx("div",{className:"p-2",children:e.jsx(ve,{className:"h-4 w-4 shrink-0 opacity-50"})}),endIcon:e.jsx(Q,{variant:"ghost",size:"inputEndIcon",onClick:()=>{l("")},children:e.jsx(qe,{className:"w-4 h-4"})})}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[!T&&e.jsx(_,{delayDuration:0,children:e.jsxs(U,{children:[e.jsx(A,{asChild:!0,children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(I,{children:"Online Status Info"}),e.jsx(J,{className:"w-4 h-4"})]})}),e.jsxs(K,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"border rounded-full w-3 h-3 bg-green-1"}),e.jsx(I,{children:L("label.statusOnlineInfo")})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"border rounded-full w-3 h-3 bg-yellow-500"}),e.jsx(I,{children:L("label.statusIdleInfo")})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"border rounded-full w-3 h-3 bg-red-1"}),e.jsx(I,{children:L("label.statusOfflineInfo")})]})]})]})}),e.jsx(ae,{value:y,onValueChange:a=>{m(a)}}),e.jsx(ae,{value:u,onValueChange:a=>{c(a)},children:e.jsx(Ge,{children:e.jsxs(_,{children:[e.jsx(ie,{value:"Seller",iconEnd:e.jsxs(U,{children:[e.jsx(A,{asChild:!0,children:e.jsx(J,{className:"w-4 h-4"})}),e.jsx(K,{children:e.jsx(I,{children:"Bosskiller provides the map and receive all loot."})})]}),children:T?"Seller's Map":"Seller's Map (Yours)"}),e.jsx(ie,{value:"Buyer",iconEnd:e.jsxs(U,{children:[e.jsx(A,{asChild:!0,children:e.jsx(J,{className:"w-4 h-4"})}),e.jsx(K,{children:e.jsx(I,{children:"Player provides the map and receive all loot."})})]}),children:"Buyers's Map"})]})})}),e.jsx(Fe,{columns:j,resetTable:t})]})]}),e.jsx(ze,{options:E,tableRef:d})]})})},Ae=({poe:S,league:j})=>{const{t:y,i18n:m}=W(["common","notification"]),u=ge(),c=o.useMemo(()=>xe(S,"wts"),[S]),[h,C]=o.useState(c[0]),[N,P]=o.useState("Seller"),[L,$]=o.useState("all"),T=he(Te),[p]=X(s=>({loaded:s.viewport.loaded,md:s.viewport.md})),f=p.loaded&&!p.md,[i,g]=F(q(s=>[s.globalRules,s.setGlobalRules])),[l,n]=F(q(s=>[s.prefferedRegions,s.setPrefferedRegions]));o.useEffect(()=>{C(c[0])},[c]);const r=o.useCallback(s=>{g({...i,[`${h.value}`]:s})},[i,h.value,g]),d=i[`${h.value}`]||[],[t,k]=o.useState({Buyer:{},Seller:{}}),B=fe(je),{modifiedListings:E,setModifiedListings:a,myListings:x}=He(B,S,j,h,k),b=o.useMemo(()=>Ce(),[]),{mutate:O,isPending:V}=Be({onSuccess:()=>{u(`/${S}/poexchange/services/my-listings`)}}),R=o.useMemo(()=>(x==null?void 0:x.filter(s=>(s.location==="Seller"&&!t.Seller[s.serviceName]||s.location==="Buyer"&&!t.Buyer[s.serviceName])&&s.serviceCategory===h.value).map(s=>({id:s.id,poe:s.poe,league:s.league,location:s.location,serviceCategory:s.serviceCategory,serviceName:s.serviceName,isCustomService:s.isCustomService})))||[],[x,t,h.value]),M=o.useMemo(()=>Object.keys(t.Buyer).length>0,[t]),v=o.useMemo(()=>!!(!T||M&&l.length===0),[T,M,l.length]),D=()=>{const s=z=>Object.keys(t[z]).flatMap(H=>{var Z;const w=E[z].find(oe=>oe.serviceName===H);if(w)return{id:Se(),userId:((Z=B==null?void 0:B.profile)==null?void 0:Z.uuid)||"",creatorType:"wts",serviceName:w.serviceName,serviceCategory:w.serviceCategory,isCustomService:w.isCustomService,message:w.message,poe:S,league:j,locale:m.language,ign:T,priceValue:w.priceValue,priceType:w.priceType,contactDirection:w.contactDirection,location:z,prefferedRegions:z==="Buyer"?l:void 0,tags:w.tags&&w.tags.length>0?w.tags:d,autoInactiveSince:void 0,inactive:!1}}).filter(H=>H!==void 0),ce=s("Seller"),ne=s("Buyer");O({addOrUpdate:[...ce,...ne],delete:R})},Y=o.useMemo(()=>Object.keys(t.Seller).length+Object.values(t.Buyer).length+R.length,[R.length,t]),te=o.useMemo(()=>c.map(s=>({value:s.value,label:y(`serviceCategory.${s.value}`),services:s.services})),[c,y]);return e.jsxs("div",{className:"flex flex-col gap-2 flex-grow",children:[e.jsxs("div",{className:"flex flex-row flex-wrap flex-grow gap-4 items-center border rounded-sm bg-background p-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(I,{required:!0,htmlFor:"character",children:"Service Type:"}),e.jsx(we,{className:"w-48",value:h.value,onSelect:s=>{C(s)},options:te})]}),M&&e.jsxs("div",{className:"space-y-1",children:[e.jsx(I,{required:!0,htmlFor:"regions",children:"Regions:"}),e.jsx(se,{id:"regions",className:"w-48",options:Me,selectedOptions:l,onSelectedOptionsChange:n,keyword:y("label.regionKw")})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(I,{htmlFor:"rules",children:"Global Rules"}),e.jsx(se,{id:"rules",className:"w-48",options:Ie,selectedOptions:d,onSelectedOptionsChange:r,keyword:y("label.rulesKw")})]}),e.jsx("div",{className:"flex-1"}),f?e.jsx(Le,{children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("span",{children:y("action.postServiceListings")}),e.jsx(Q,{className:"rounded-full",variant:"default",size:"floatingIconPrimary",disabled:Y===0||v||V,onClick:D,children:V?e.jsx(ee,{className:"animate-spin w-5 h-5 shrink-0"}):e.jsx(be,{className:"w-5 h-5 shrink-0"})})]})}):e.jsxs(Q,{className:"flex flex-row gap-2",disabled:Y===0||v||V,onClick:D,children:[e.jsx("span",{className:"truncate",children:y("action.postServiceListings")}),e.jsx(ee,{className:re(V&&"animate-spin","w-4 h-w shrink-0")})]})]}),e.jsx("div",{className:"overflow-auto w-full",children:e.jsx("div",{className:"flex flex-col gap-2 w-full relative",children:e.jsx(Ue,{className:"flex flex-col gap-2 w-full",columns:b,selectedStatus:L,setSelectedStatus:$,currentLocation:N,setCurrentLocation:P,modifiedListings:E,setModifiedListings:a,selectedServices:t,setSelectedServices:k})})})]})};ye.extend(Ne);function cs(){const[S,j,y]=F(q(c=>[c.league,c.setLeague,c.reset])),m=F(c=>c.poe);ue(m,S,j,y);const[u]=X(c=>({lg:c.viewport.lg}));return e.jsx(e.Fragment,{children:e.jsxs("div",{className:re("flex flex-col gap-5 w-full"),children:[e.jsx(de,{id:"poexchange-top-ad",type:u.lg?"large-leaderboard":"medium-leaderboard"}),e.jsx(Ae,{poe:m,league:S})]})})}export{cs as M};
