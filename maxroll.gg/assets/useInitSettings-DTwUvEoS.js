import{C as oe,a2 as C,aM as Fe,aN as Ee,aO as Le,aP as Ue,U as v,aQ as Me,aR as ve,aS as Ie,G as be,aT as xe,J as Ce,L as Oe,aU as Ae,aV as $e,y as re,aW as Ne,aX as Te,a9 as ke}from"./useUiStateStore-BTW2eq2x.js";import{r as c}from"./jsx-runtime-BmCkTyBI.js";import{K as ie}from"./index-bpJNUpaV.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],Ge=oe("user",we);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]],Je=oe("play",De),ze=(t,d,e)=>{const a=c.useRef(!1);c.useEffect(()=>{e&&d&&(a.current=!0)},[e,d]);const i=e&&t&&!d;return!a.current&&i};function qe(t,d,e=null,a=!0){const{data:i,isFetched:p,isError:f}=C(Fe(d,t,e,a)),h=c.useMemo(()=>i?i.flatMap(n=>{var r;return(r=n.children)!=null&&r.length?n.children:[n]}):[],[i]);return{stashesSortedByPrioity:c.useMemo(()=>{const n={Folder:0,UniqueStash:0,FlaskStash:3,GemStash:4,NormalStash:5,PremiumStash:5,QuadStash:5,MapStash:10,BlightStash:10,DeliriumStash:10,UltimatumStash:10,DelveStash:10,EssenceStash:15,DivinationCardStash:16,FragmentStash:17,CurrencyStash:18},r=h.filter(l=>l.type!=="Folder"&&l.type!=="UniqueStash"&&!l.name.includes("(Remove-only)")).toSorted((l,u)=>{const m=n[l.type]??10;return(n[u.type]??10)-m}),P=new Set,S=[],E=[];for(const l of r)P.has(l.type)?S.push(l):(P.add(l.type),E.push(l));return E.push(...S),E},[h]),isStashListFetched:p,isStashListError:f}}const Be=(t,d)=>{var h;const{data:e,isFetched:a,isLoading:i,isPending:p,isError:f}=C(Ee(d));return{snapshotProfile:c.useMemo(()=>{var r;const n=(r=t==null?void 0:t.profile)==null?void 0:r.uuid;return!n||!e||e.userId!==n?e:{...e,isCurrentUserProfile:!0}},[(h=t==null?void 0:t.profile)==null?void 0:h.uuid,e]),isSnapshotProfileFetched:a,isSnapshotProfileLoading:i,isSnapshotProfilePending:p,isSnapshotProfileError:f}},ne=(t,d,e,a)=>{const{data:i,isPending:p,isFetching:f,isFetched:h,isError:n}=C(Le(e,d,a));return{snapshotProfiles:c.useMemo(()=>{var P;const r=(P=t==null?void 0:t.profile)==null?void 0:P.uuid;return!r||!e||r!==e||!i?i:i.map(S=>({...S,isCurrentUserProfile:!0}))},[t==null?void 0:t.profile,i,e]),isSnapshotProfilesPending:p,isSnapshotProfilesFetching:f,isSnapshotProfilesFetched:h,isSnapshotProfilesError:n}};function Qe(t,d,e=!0){const{data:a,isError:i,isLoading:p,isFetched:f}=C(Ue(d,t,e)),h=c.useMemo(()=>{if(!a)return;const l=["path of exile: royale"];return a.filter(u=>{var m;return!l.includes(u.id)&&!((m=u.rules)!=null&&m.some(L=>L.id==="NoParties"))&&!u.privateLeagueUrl&&!u.scoreEvent&&!u.ancestorEvent&&(!u.startAt||v.utc(u.startAt).isBefore(v.utc()))&&(!u.endAt||v.utc(u.endAt).isAfter(v.utc()))})},[a]),{data:n,isError:r,isFetched:P,isLoading:S}=C(Me(d,t,e)),E=c.useMemo(()=>{if(!n||!a)return;const l=ve(n,u=>u.league).map(u=>u.league);return a.filter(u=>l.includes(u.id))},[n,a]);return{leagues:a,characters:n,selectablePriceLeagues:h,selectableCharacterLeagues:E,isLeagueFetched:f,isCharactersFetched:P,isLeaguesError:i,isCharactersError:r,isLeaguesLoading:p,isCharactersLoading:S}}const Ve=(t,d,e,a,i)=>{var te,se;const[p,f]=ie("user",{parse:s=>s||null,clearOnDefault:!1}),h=p||void 0,[n,r]=ie("profileId",{parse:s=>s||null,clearOnDefault:!1}),P=n||void 0,S=be(),E=xe(),l=Ce(),u=(te=Oe(Ae))==null?void 0:te.nextManualSnapshotAt,{availableSnapshotProfiles:m,currentUserSnapshotProfiles:L,isCurrentUserSnapshotProfilesFetching:$,isSnapshotProfilesPending:le,isSnapshotProfilesFetched:ue,selectedOtherUser:Z,isSelectedOtherUserPending:j,selectedOtherUserFetchEnabled:G}=He(e,a,h),{data:H,isFetched:de,isPending:J,refetch:V}=C($e(t,(se=e==null?void 0:e.profile)==null?void 0:se.uuid,d)),W=c.useMemo(()=>L==null?void 0:L.filter(s=>!s.readOnly),[L]),[X,ce]=Ze(e,L,H,r,f),b=c.useMemo(()=>{var s;return $||!m||m.some(T=>T.id===P)?P:X||((s=m[0])==null?void 0:s.id)},[$,m,X,P]),{snapshotProfile:x,isSnapshotProfileFetched:fe,isSnapshotProfilePending:K,isSnapshotProfileError:Y}=Be(e,b);c.useEffect(()=>{!b||P===b||r(b??null)},[b,P,r]),c.useEffect(()=>{if(G&&!j&&!Z)if(e!=null&&e.profile.name)f(e.profile.name);else{const s=localStorage.getItem("poexchange-last-selected-user-name");f(s),r(null)}else if(!h)if(e!=null&&e.profile.name)f(e.profile.name);else{const s=localStorage.getItem("poexchange-last-selected-user-name");f(s),r(null)}},[e==null?void 0:e.profile.name,j,Z,G,h,r,f]),c.useEffect(()=>{localStorage.setItem("poexchange-last-selected-user-name",h||"")},[h]),c.useEffect(()=>{K||!Y||l("Failed to fetch the snapshot profile. Please try again later.","error")},[Y,K,l]);const I=e&&H===null,O=!I&&W&&W.length===0,_=re({mutationFn:s=>Ne(a,s),onSuccess:()=>{var s;S.invalidateQueries({queryKey:["networth-profiles",(s=e==null?void 0:e.profile)==null?void 0:s.uuid,a],exact:!0})}}),he=re({mutationFn:Te,onSuccess:(s,T)=>{var z;console.log("Profile added successfully:",s),r(T.body.id),S.invalidateQueries({queryKey:["networth-profiles",(z=e==null?void 0:e.profile)==null?void 0:z.uuid,a],exact:!0})}}),pe=i.mutate,ge=i.isPending;c.useEffect(()=>{if(!(J||!x||!x.isCurrentUserProfile||x.readOnly||x.snapshotCount!==0||ge||!u)){if(u.isAfter(v.utc())){console.log("Next manual snapshot is scheduled in the future, skipping initial snapshot creation.");return}pe({type:"manual",profile:x})}},[x,u==null?void 0:u.valueOf()]);const{characters:N,selectablePriceLeagues:M,selectableCharacterLeagues:U,isCharactersFetched:w,isLeagueFetched:D}=Qe(e,E,I||O),{league:y,priceLeague:A}=c.useMemo(()=>{var ae;if(!(I||O)||!w||!D||!U||U.length===0||!M||M.length===0)return{};const s=(ae=N==null?void 0:N.filter(o=>U.some(g=>g.id===o.league)))==null?void 0:ae.find(o=>o.current),T=o=>{var g;return(g=o.rules)==null?void 0:g.some(F=>F.id==="NoParties")},z=o=>{var g;return(g=o.rules)==null?void 0:g.some(F=>F.id==="Hardcore")},me=o=>{var g;return(g=o.rules)==null?void 0:g.some(F=>F.id==="HardMode")},q=o=>z(o)?1:me(o)?2:T(o)?3:0,Se=M.toSorted((o,g)=>{const F=v.utc(o.startAt??"2013-01-23T21:00:00Z").diff(v.utc(g.startAt??"2013-01-23T21:00:00Z")),k=F>0?-1:F<0?1:0;return k!==0?k:q(o)-q(g)})[0],ye=U.toSorted((o,g)=>{const F=v.utc(o.startAt??"2013-01-23T21:00:00Z").diff(v.utc(g.startAt??"2013-01-23T21:00:00Z")),k=F>0?-1:F<0?1:0;return k!==0?k:q(o)-q(g)})[0];let B,Q=Se;return s?(B=U.find(o=>o.id===s.league),M.some(o=>o.id===s.league)&&(Q=M.find(o=>o.id===s.league))):U.some(o=>o.id===Q.id)?B=Q:B=ye,{league:B,priceLeague:Q}},[N,w,D,U,M,O,I]),{stashesSortedByPrioity:R,isStashListFetched:ee}=qe(e,E,y==null?void 0:y.id,I||O);c.useEffect(()=>{(async()=>{if(!(!(I||O)||!w||!D||!ee)){if(!y||!U||U.length===0)return l("No leagues found for your characters. Please create a character first","error");if(!A||!M||M.length===0)return l("No price leagues found for your account. You may wait for the league start.","error");if(I)try{await _.mutateAsync({activeLeague:y,activePriceLeague:A.id!==y.id?A:void 0,stashTabs:R.slice(0,5).map(s=>({tabId:s.tabId,league:y.id,poe:a,parentId:s.parent??null,index:s.index,name:s.name,type:s.type,metadata:s.metadata}))})}catch(s){return console.error("Failed to initialize snapshot settings:",s),l("Failed to initialize snapshot settings","error")}else try{await he.mutateAsync({socket:t,body:{id:ke(),name:"Default Profile",poe:a,activeLeague:y,activePriceLeague:A.id!==y.id?A:void 0,stashTabs:R.slice(0,6).map(s=>({tabId:s.tabId,league:y.id,poe:a,parentId:s.parent??null,index:s.index,name:s.name,type:s.type,metadata:s.metadata})),isAutoSnapshotProfile:!0}})}catch(s){return console.error("Failed to add default profile to snapshot settings:",s),l("Failed to add default profile to snapshot settings","error")}V()}})()},[N,w,D,ee,y,a,A,V,U,M,O,I,R,l]);const Pe=ze(K,fe,!!b);return{snapshotSettings:H??void 0,selectedSnapshotProfile:x??void 0,currentUserSnapshotProfiles:L,availableSnapshotProfiles:m,profileInitializationPending:le&&!ue||e&&J&&!de||Pe||_.isPending,selectPreferredCurrentUserNameAndProfileId:ce,selectedUserName:h,selectedProfileId:b,setSelectedProfileId:r,selectedOtherUser:Z}},Ze=(t,d,e,a,i)=>{var n;const p=c.useMemo(()=>d==null?void 0:d.filter(r=>!r.readOnly),[d]),f=c.useMemo(()=>!p||p.length===0?null:e!=null&&e.autoSnapshotProfileId&&p.some(r=>r.id===e.autoSnapshotProfileId)?e.autoSnapshotProfileId:p[0].id,[p,e==null?void 0:e.autoSnapshotProfileId]),h=c.useCallback(()=>{var r;a(((r=t==null?void 0:t.profile)==null?void 0:r.name)||null),f&&i(f)},[(n=t==null?void 0:t.profile)==null?void 0:n.name,f,i,a]);return[f,h]},He=(t,d,e)=>{var $;const a=c.useMemo(()=>(t==null?void 0:t.profile.name)===e,[t,e]),{data:i,isPending:p,isFetched:f,isError:h}=C(Ie(e,!a)),{snapshotProfiles:n,isSnapshotProfilesPending:r,isSnapshotProfilesFetching:P,isSnapshotProfilesFetched:S,isSnapshotProfilesError:E}=ne(t,d,t==null?void 0:t.profile.uuid),{snapshotProfiles:l,isSnapshotProfilesPending:u,isSnapshotProfilesFetched:m,isSnapshotProfilesError:L}=ne(t,d,i==null?void 0:i.uuid,!a);return{availableSnapshotProfiles:c.useMemo(()=>{if(a)return n;if(!(!a&&!l||t&&!n))return[...l??[],...n??[]]},[t,n,a,l]),currentUserSnapshotProfiles:n,selectedOtherUser:i,isSelectedOtherUserPending:!a&&p,selectedOtherUserFetchEnabled:!a,isCurrentUserSnapshotProfilesFetching:P,isSnapshotProfilesPending:!a&&p||(($=t==null?void 0:t.profile)==null?void 0:$.uuid)&&r||(i==null?void 0:i.uuid)&&!a&&u,isSnapshotProfilesFetched:f||S||m,isSnapshotProfilesError:h||E||L}};export{He as M,Qe as O,Je as a,Be as m,Ge as r,ze as s,Ve as t};
