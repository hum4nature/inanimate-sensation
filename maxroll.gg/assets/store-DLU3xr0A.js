var q=Object.defineProperty;var N=(a,s,l)=>s in a?q(a,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[s]=l;var j=(a,s,l)=>N(a,typeof s!="symbol"?s+"":s,l);import{U as R,V as A,X as D,N as k,Y as H,Q as $,R as U,i as z,u as b}from"./useUiStateStore-BTW2eq2x.js";import{S as K}from"./immer-Dw4EE-Qj.js";const w=a=>a.tHash||a.hash,O=(a,s,l,u)=>{const d=a.get(s);d?(u||0)>(d.minQuantity||0)&&(d.minQuantity=u):a.set(s,{items:l,minQuantity:u})},L=(a,s,l)=>{const u=l.get(a);return!!(u&&u.reduce((d,i)=>d+i.quantity,0)>=(s||0))},W=(a,s)=>Object.entries(a).length===0?!0:!Object.entries(a).some(([l,u])=>{var d,i;if(L(l,u.minimumQuantity,s))return!0;if(((d=a[l])==null?void 0:d.freeTextMode)==="OR")return(i=a[l].freeTextOptions)==null?void 0:i.some(e=>{if(L(e.hash,u.minimumQuantity,s))return!0})}),X=(a,s,l)=>Object.entries(a).every(([u,d])=>{var i,e;if(L(u,d.minimumQuantity,s))return O(l,u,s.get(u)||[],d.minimumQuantity),!0;if(((i=a[u])==null?void 0:i.freeTextMode)==="OR")return(e=a[u].freeTextOptions)==null?void 0:e.some(t=>{if(L(t.hash,d.minimumQuantity,s))return O(l,t.hash,s.get(t.hash)||[],d.minimumQuantity),!0})}),Y=(a,s,l)=>a.every(u=>u.filters.filter(d=>{var i,e,t;if(d.freeText===void 0&&((i=d.option)!=null&&i.hash)){const r=d.option.hash;if(L(r,d.minimumQuantity,s))return O(l,r,s.get(r)||[],d.minimumQuantity),!0}if(d.freeTextMode==="AND")return(e=d.freeTextOptions)==null?void 0:e.every(r=>{if(L(r.hash,d.minimumQuantity,s))return O(l,r.hash,s.get(r.hash)||[],d.minimumQuantity),!0});if(d.freeTextMode==="OR")return(t=d.freeTextOptions)==null?void 0:t.some(r=>{if(L(r.hash,d.minimumQuantity,s))return O(l,r.hash,s.get(r.hash)||[],d.minimumQuantity),!0})}).length>=u.minQuantity),G=(a,s,l,u=!1)=>{var d,i;a[l]={...s,freeText:void 0,freeTextOptions:u&&s.freeTextOptions||((d=a[l])==null?void 0:d.freeTextOptions)||null,freeTextMode:u&&s.freeTextMode||((i=a[l])==null?void 0:i.freeTextMode)||void 0}},V=(a,s)=>{var l;if(s.freeText===void 0&&((l=s.option)!=null&&l.hash)&&(!a[s.option.hash]||(s.minimumQuantity||0)>(a[s.option.hash].minimumQuantity||0)))return G(a,s,s.option.hash),!0},C=(a,s)=>{var l;if(s.freeText!==void 0&&s.freeTextMode==="AND")return(l=s.freeTextOptions)==null||l.forEach(u=>{u.hash&&(!a[u.hash]||(s.minimumQuantity||0)>(a[u.hash].minimumQuantity||0))&&G(a,s,u.hash)}),!0},F=(a,s)=>{var l;if(s.freeText!==void 0&&s.freeTextMode==="OR")return(l=s.freeTextOptions)==null||l.forEach(u=>{u.hash&&(!a[u.hash]||(s.minimumQuantity||0)>(a[u.hash].minimumQuantity||0))&&G(a,s,u.hash,!0)}),!0};class P{static filterItems(s,l){const{andFilters:u,countGroups:d,notFilters:i}=this.combineFilter(l),e=Object.keys(u).length===0,t=d.length===0||d.every(g=>g.filters.length===0),r=new Map;s.map(g=>{const h=r.get(w(g));h?h.push(g):r.set(w(g),[g])});const n=new Map,o=W(i,r);let p=!0,f=!0;o&&(p=X(u,r,n),f=Y(d,r,n));const c={};if(o&&p&&f)for(const[,{items:g,minQuantity:h}]of n){let T=h||0;const B=g.reduce((M,Q)=>{var v;return M+(((v=c[Q.hash])==null?void 0:v.minQuantity)||0)},0);(!B||B<(h||0))&&g.toSorted((M,Q)=>M.price-Q.price).forEach(M=>{let Q=M.quantity;h?T>0?(Q=T-M.quantity>=0?M.quantity:T,T-=Q,c[M.hash]={item:M,minQuantity:Q,selected:!0}):Q=0:c[M.hash]={item:M,minQuantity:Q,selected:!0}})}s.forEach(g=>{n.has(w(g))||(c[g.hash]={item:g,minQuantity:g.quantity,selected:e&&t})});const m=o&&p&&f;return{valid:m,items:m?Object.values(c):[]}}}j(P,"combineFilter",s=>{s=s??[];const l={},u=s.filter(t=>t.selected&&t.mode==="AND"),d=u.length>0;u.flatMap(t=>t.filters).forEach(t=>{t.selected&&(V(l,t)||C(l,t)||F(l,t))});const i=[];s.filter(t=>t.selected&&t.mode==="COUNT").forEach(t=>{const r={},n=[];t.filters.forEach(o=>{var p,f;if(o.selected){if(V(r,o))r[o.option.hash]={...o},n.push(o);else if(o.freeText!==void 0&&o.freeTextMode==="AND"){const c=(p=o.freeTextOptions)==null?void 0:p.filter(m=>{if(m.hash&&(!r[m.hash]||(o.minimumQuantity||0)>(r[m.hash].minimumQuantity||0)))return G(r,o,m.hash),!0});n.push({...o,freeTextOptions:c||null})}else if(o.freeText!==void 0&&o.freeTextMode==="OR"){const c=(f=o.freeTextOptions)==null?void 0:f.filter(m=>{if(m.hash&&(!r[m.hash]||(o.minimumQuantity||0)>(r[m.hash].minimumQuantity||0)))return G(r,o,m.hash,!0),!0});n.push({...o,freeTextOptions:c||null})}}}),i.push({minQuantity:t.minimumQuantity||0,filters:n})});const e={};return s.filter(t=>t.selected&&t.mode==="NOT").flatMap(t=>t.filters).forEach(t=>{t.selected&&(V(e,t)||C(e,t)||F(e,t))}),{hasAndGroups:d,andFilters:l,countGroups:i,notFilters:e}});R.extend(A);const _=2*60*60*1e3,E=(a,s)=>{if(a.meta.listingMode==="bulk"){s[a.uuid]||(s[a.uuid]={});return}let l=0,u=0,d=0,i=0;s[a.uuid]?a.items.forEach(t=>{if(!s[a.uuid][t.hash])return;const r=t.price*t.selectedQuantity;l+=r,i+=(a.meta.regexExtraPrice||0)*t.selectedQuantity,t.primaryValuation!==void 0&&(u+=r,d+=t.primaryValuation*t.selectedQuantity)}):s[a.uuid]={};let e;u&&d&&(e=u/d*100),a.meta.calculatedTotalPrice=b(l,4),a.meta.multiplier=e?b(e,1):void 0,a.meta.calculatedExtraPrice=b(i,4)},y=(a,s,l)=>(s||(a==null?void 0:a.category)||"")+(l||(a==null?void 0:a.subCategory)||""),I=a=>{const s=y(a);if(a.subCategory)return a.listingsMap[s];const l=D(a.category),u=[];if(l)u.push(...a.listingsMap[s]||[]),l.subCategories.forEach(d=>{const i=y(void 0,a.category,d.name);u.push(...a.listingsMap[i]||[])});else return Object.entries(a.listingsMap).flatMap(([d,i])=>i);return u},x=(a,s,l,u,d)=>{a.forEach(i=>{let e=0,t=0,r=0,n=0;const{items:o,valid:p}=P.filterItems(i.items,l);if(u[i.uuid]=p,s[i.uuid]={},i.meta.listingMode==="bulk")return o.forEach(({item:c})=>{s[i.uuid][c.hash]=!0});o.forEach(({item:c,minQuantity:m,selected:g})=>{if(m!==void 0?c.selectedQuantity=m:c.selectedQuantity=c.quantity,c.maxSelectableQuantity=void 0,!g)return;s[i.uuid][c.hash]=!0;const h=c.price*c.selectedQuantity;e+=h,n+=(i.meta.regexExtraPrice||0)*c.selectedQuantity,c.primaryValuation!==void 0&&(t+=h,r+=c.primaryValuation*c.selectedQuantity)});let f;t&&r&&(f=t/r*100),i.meta.calculatedTotalPrice=b(e,4),i.meta.multiplier=f?b(f,1):void 0,i.meta.calculatedExtraPrice=b(n,4)})},J=()=>[{selected:!0,mode:"AND",filters:[]}],S=(a,s)=>a.filterGroups[s??y(a)]||J(),ie=a=>{const s=z(a),l={poe:a,dialogOpen:!1,league:s[0],category:null,subCategory:null,multiplierRange:[0,500],fetchTimeStamps:Object.fromEntries(s.map(u=>[u,{"":0}])),filterGroups:{},listingsMap:{},selectedListingId:null,selectedItemsMap:{},filteredByGroupListings:{},whisperedListings:{},filterListingByMinTradeValue:!1,tablePageIndex:0};return k()(H($(K((u,d)=>({...l,reset:()=>u(l),setDialogOpen:i=>u(e=>{if(!i){const t=I(e).find(r=>r.uuid===e.selectedListingId);if(t){const r=S(e);x([t],e.selectedItemsMap,r,e.filteredByGroupListings,e.filterListingByMinTradeValue)}}e.dialogOpen=i}),setLeague:i=>u({league:i}),setCategory:i=>u(e=>{e.category!==i&&(e.subCategory=null),e.category=i;const t=y(e);e.listingsMap[t]||(e.listingsMap[t]=[]),s.forEach(r=>{e.category&&e.fetchTimeStamps[r][e.category]===void 0&&(e.fetchTimeStamps[r][e.category]=0)}),e.filterGroups[t]=S(e,t),e.filteredByGroupListings={},x(I(e),e.selectedItemsMap,e.filterGroups[t],e.filteredByGroupListings,e.filterListingByMinTradeValue),e.tablePageIndex=0}),setSubCategory:i=>u(e=>{e.subCategory=i;const t=y(e);e.listingsMap[t]||(e.listingsMap[t]=[]),s.forEach(r=>{e.category&&e.fetchTimeStamps[r][e.category]===void 0&&(e.fetchTimeStamps[r][e.category]=0)}),e.filterGroups[t]=S(e,t),e.filteredByGroupListings={},x(I(e),e.selectedItemsMap,e.filterGroups[t],e.filteredByGroupListings,e.filterListingByMinTradeValue),e.tablePageIndex=0}),setMultiplierRange:i=>u(e=>{e.multiplierRange=i,e.tablePageIndex=0}),setFetchTimestamps:i=>u(e=>{(e.category||"")===""?Object.keys(e.fetchTimeStamps[e.league]).forEach(t=>{e.fetchTimeStamps[e.league][t]=i}):e.fetchTimeStamps[e.league][e.category||""]=i}),setFilterGroups:i=>u(e=>{const t=y(e);e.filterGroups[t]=i,t&&(e.filteredByGroupListings={},x(I(e),e.selectedItemsMap,e.filterGroups[t],e.filteredByGroupListings,e.filterListingByMinTradeValue),e.tablePageIndex=0)}),addListings:(i,e,t,r)=>u(n=>{const o=y(void 0,t,r);n.listingsMap[o]||(n.listingsMap[o]=[]),n.filterGroups[o]||(n.filterGroups[o]=S(n,o)),n.fetchTimeStamps[n.league][t]===void 0&&(n.fetchTimeStamps[n.league][t]=0);const p=e.filter(f=>{const c=n.listingsMap[o].findIndex(m=>m.userId===f.userId&&m.meta.league===f.meta.league);if(c!==-1){if(f.deleted||f.inactive)n.dialogOpen&&n.selectedListingId===f.uuid&&(n.dialogOpen=!1,console.warn("The dialog was closed because the opened listing was deleted"),i("Sorry! The selected listing has been deleted!","warning",{game:n.poe})),n.selectedItemsMap[f.uuid]&&delete n.selectedItemsMap[f.uuid],n.filteredByGroupListings[f.uuid]&&delete n.filteredByGroupListings[f.uuid],n.listingsMap[o].splice(c,1);else{const m=n.listingsMap[o][c];if(m.uuid!==f.uuid){if(n.dialogOpen&&n.selectedListingId===m.uuid){n.selectedListingId=f.uuid,console.warn("The dialog was updated because the opened listing was replaced"),i("The listing has been updated!","warning",{game:n.poe}),n.selectedItemsMap[m.uuid]&&(n.selectedItemsMap[f.uuid]={},Object.keys(n.selectedItemsMap[m.uuid]).forEach(h=>{f.items.some(T=>T.hash===h)&&(n.selectedItemsMap[f.uuid][h]=!0)})),f.items.forEach(h=>{const T=m.items.find(B=>B.hash===h.hash);T&&(h.selectedQuantity=Math.min(T.selectedQuantity,h.quantity))}),E(f,n.selectedItemsMap);const{valid:g}=P.filterItems(f.items,n.filterGroups[y(n)]);n.filteredByGroupListings[f.uuid]=g}else x([f],n.selectedItemsMap,n.filterGroups[y(n)],n.filteredByGroupListings,n.filterListingByMinTradeValue);n.selectedItemsMap[m.uuid]&&delete n.selectedItemsMap[m.uuid],n.filteredByGroupListings[m.uuid]&&delete n.filteredByGroupListings[m.uuid],n.listingsMap[o].splice(c,1,f)}}return!1}return!(f.deleted||f.inactive)});x(p,n.selectedItemsMap,n.filterGroups[y(n)],n.filteredByGroupListings,n.filterListingByMinTradeValue),n.listingsMap[o]?p.length>0&&n.listingsMap[o].push(...p):n.listingsMap[o]=p,p.forEach(f=>{n.selectedItemsMap[f.uuid]||(n.selectedItemsMap[f.uuid]={})})}),cleanupListings:i=>u(e=>{if(!y(e))return;const t=R.utc().valueOf();let r=e.listingsMap[y(e)].length;for(;r--;){const n=e.listingsMap[y(e)][r];t-n.meta.timestampMs>_&&(e.dialogOpen&&e.selectedListingId===n.uuid&&(e.dialogOpen=!1,console.warn("The dialog was closed because the opened listing got stale"),i("Sorry! The selected listing is stale and got deleted!","warning",{game:e.poe})),e.selectedItemsMap[n.uuid]&&delete e.selectedItemsMap[n.uuid],e.filteredByGroupListings[n.uuid]&&delete e.filteredByGroupListings[n.uuid],e.listingsMap[y(e)].splice(r,1))}}),addWhisperedListing:(i,e)=>u(t=>{t.whisperedListings[i]?(t.whisperedListings[i].sentHashes.includes(e)||t.whisperedListings[i].sentHashes.push(e),t.whisperedListings[i].lastCopiedHash=e):t.whisperedListings[i]={sentHashes:[e],lastCopiedHash:e}}),setSelectedListingId:i=>u({dialogOpen:!0,selectedListingId:i}),setSelectedItems:i=>u(e=>{typeof i=="function"?e.selectedItemsMap[e.selectedListingId||""]=i(e.selectedItemsMap[e.selectedListingId||""]):e.selectedItemsMap[e.selectedListingId||""]=i;const t=I(e).find(r=>r.uuid===e.selectedListingId);t&&E(t,e.selectedItemsMap)}),setSelectedQuantities:i=>u(e=>{const t=I(e).find(r=>r.uuid===e.selectedListingId);t&&(t.items.forEach(r=>{const n=i===void 0,o=i==null?void 0:i.find(p=>p.hash===r.hash);o?(r.selectedQuantity=o.quantity,r.maxSelectableQuantity=o.maxQuantity):n?r.maxSelectableQuantity=void 0:(r.selectedQuantity=0,r.maxSelectableQuantity=0)}),E(t,e.selectedItemsMap))}),updateData:(i,e,t)=>u(r=>{const n=I(r).find(p=>p.uuid===r.selectedListingId);if(!n)return{};const o=n.items.find(p=>p.hash===i);o&&e==="selectedQuantity"&&(typeof t=="number"?o.selectedQuantity=t:o.selectedQuantity=0),E(n,r.selectedItemsMap)}),setFilterListingByMinTradeValue:i=>u(e=>{e.filterListingByMinTradeValue=i;const t=y(e);t&&(e.filteredByGroupListings={},x(I(e),e.selectedItemsMap,e.filterGroups[t],e.filteredByGroupListings,e.filterListingByMinTradeValue),e.tablePageIndex=0)}),setTablePageIndex:i=>u({tablePageIndex:i})})),{name:`poexchange-${a}-listings-items-store`,storage:U(()=>localStorage),version:1,migrate:(u,d)=>{const i=u;return i&&typeof i=="object"&&"league"in i&&(i.league=s[0]),i},partialize:u=>{const d=Object.entries(u.filterGroups).map(([e,t])=>{const r=t.map(n=>{const o=n.filters.map(p=>({...p,freeTextOptions:null}));return{...n,filters:o}});return[e,r]}),i=Object.fromEntries(d);return{league:u.league,filterGroups:i}}})))};export{_ as F,J as K,ie as _,y as f,I as h};
