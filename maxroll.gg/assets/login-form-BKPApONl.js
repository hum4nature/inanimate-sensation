import{r,j as F}from"./jsx-runtime-BmCkTyBI.js";import{u as E}from"./index-DaXM-EJC.js";import{U}from"./user-auth-card-B_q7Ra4P.js";import{u as x}from"./ory-utils-CWGoKueJ.js";import{u as C}from"./context-D_yk-qIR.js";import{u as P}from"./external-libs-Cwu5KtnL.js";import{g as T}from"./util-DPeyOfYu.js";const k="redirectTo",y=o=>{var t,s,n;for(const a of((t=o==null?void 0:o.ui)==null?void 0:t.nodes)??[])((s=a.attributes)==null?void 0:s.name)==="identifier"&&a.meta.label&&(a.meta.label.text="Email / Username"),((n=a.attributes)==null?void 0:n.name)==="traits.privacyPolicy"&&(window.location.href="/auth/registration");return o};function M(){const o=P(),[t,s]=r.useState(null),[n,a]=E(),{user:p,loginDialogOpen:_}=C(),l=r.useCallback(e=>{y(e),s(e)},[s]),c=n.get("aal2"),d=n.get("return_to"),h=n.get("login_challenge"),g=n.get("flow"),f=n.get(k),m=r.useCallback(e=>o.getLoginFlow({id:e}).then(({data:i})=>{l(i)}).catch(u),[o,l]),u=x(m,l,"/auth/login",!0),w=r.useCallback(()=>{o.createBrowserLoginFlow({refresh:!0,aal:c?"aal2":"aal1",...h&&{loginChallenge:h},returnTo:d||window.location.href}).then(({data:e})=>{a({flow:e.id}),l(e)}).catch(u)},[o,u,a,l,c,d,h]),L=r.useCallback(e=>{if(_[1](!1),f){window.location.href=f;return}const i=T(document);if(!p){window.location.href=i;return}window.location.href=i},[_,p,f]),R=r.useCallback(({body:e})=>{t&&o.updateLoginFlow({flow:t.id,updateLoginFlowBody:e}).then(({data:i})=>{if(!c&&!i.session.identity){window.location.href="/auth/login?aal2=true";return}L(i)}).catch(u)},[o,u,t,c,L]),S=r.useRef(!1);r.useEffect(()=>{if(!S.current){if(S.current=!0,g){m(g).catch(w);return}w()}},[w,g,m]);const b=r.useMemo(()=>{if(t)return{forgotPasswordURL:{handler:()=>{const e=new URLSearchParams;t.return_to&&e.set("return_to",t.return_to),window.location.href=`/auth/recovery?${e.toString()}`}},signupURL:{handler:()=>{const e=new URLSearchParams;t.return_to&&e.set("return_to",t.return_to),t.oauth2_login_challenge&&e.set("login_challenge",t.oauth2_login_challenge),window.location.href=`/auth/registration?${e.toString()}`}},logoutURL:"/auth/logout"}},[t]);return t?F.jsx(U,{title:t.requested_aal!=="aal2"?"Sign In":"Two-Factor Authentication",flowType:"login",flow:t,additionalProps:b,includeScripts:!0,onSubmit:R}):F.jsx("div",{children:"Loading..."})}export{M as L};
